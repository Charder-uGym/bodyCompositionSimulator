<!--https://demos.telerik.com/kendo-ui/content/shared/js/mobile-examples.js-->
<!--?displayName=小華&userId=U722be0c9c9d36e011c0e556bd2047819&pictureUrl=www.google.com-->
<!--?displayName=小A&userId=U72Abe0c9c9d36e011c0e556bd2047819&pictureUrl=https://media.tractorsupply.com/is/image/TractorSupplyCompany/1305371?$456$-->
    
<!DOCTYPE html>
<html>

<head>
  <title></title>
  <meta name="msapplication-tap-highlight" content="no" />

  <!--  using Noto Sans TC is added by Paul Kang-->
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
  
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  
  <script src="sampleData.js"></script>
  <script src="samplePicBase64.js"></script>
</head>

<body id="body">

  <style>
    .NotoSansFont {
      font-family: 'Noto Sans TC'; 
    }
  </style>
  
  <h2 class="NotoSansFont" style="text-align:center">身體組分析儀 模擬機</h2>
  
  <div style="width:50%">
  <select id="machineSN_select" style="font-size:18px;  margin-top: 2px; height:35px" class="NotoSansFont" onchange="changeMachine()">
    <option value="T00000001">打鐵 永和店 T00000001</option>
    <option value="T00000002">打鐵 板橋店 T00000002</option>   
    <option value="T99999999">未來 未來店 T99999999</option>      
  </select>
        
    <button class="NotoSansFont" style="font-size:18px; float:right " onclick="powerToggle()">Power</button><br><br> 
  </div>
  
  <div class="NotoSansFont" id="cloudMsgDiv" style="width:50%; margin:0 ; height:500px;background-color:gray;color:white; padding:5px; float:left">
   
    <span id="powerStatusIcon" style="width:20px;height:20px; background-color:black; float:right;border-radius:10px"></span>
    <span id="powerStatus" style="float:right;margin-right:10px">POWER OFF</span><br>
                
    <p id="machineType" style="text-align:center; font-size:20px; margin-top:-20px; margin-bottom: 0px; padding-left:80px"><b></b></p>
    
    <p style="">Get cmd: response</p>
    <div >
      <p style="margin:0px" id="get_timeStamp">Timestamp:</p>
      <p id="get_cmd">cmd:</p>    
      <p>get raw data:</p>
      <p id="getCloudResponse"></p>       
    </div> 

    <hr>
    <p style="">Post status: response</p>
    <div >
      <p style="margin:0px" id="post_timeStamp">Timestamp:</p>
      <p id="post_status">status:</p>    
      <p>post raw data:</p>
      <p id="postCloudResponse"></p>       
    </div>                                                       
  </div>
  
  <div id="buttons" style="margin-left:53%">
    <button width="100px" style="font-size:18px; margin-top:10px;" onclick="getCMD()">Get select CMD</button><br>    
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('select_confirmed')" >POST select_confirmed</button><br>
    <button width="100px" style="font-size:18px; margin-top:10px;" onclick="getCMD()">Get user_info CMD</button><br>   
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('user_info_confirmed')" >POST user_info_confirmed</button><br>
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('logged_in')">POST logged_in</button><br> 
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('start_weight_measurement')">POST start_weight_measurement</button><br>
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('weight_measurement_done')">POST weight_measurement_done</button><br>
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('check_electrodes')">POST check_electrodes</button><br>    
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('check_electrodes_done')">POST check_electrodes_done</button><br>  
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('start_bodycomposition_analysis')">POST start_bodycomposition_analysis</button><br>
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('bodycomposition_analysis_results')">POST bodycomposition_analysis_results</button><br><br>
    
    <button style="font-size:18px; margin-top:10px;" onclick="postStatus('cancel_confirmed')">POST cancel_confirmed</button><br><br>    
    
    <button class="NotoSansFont" style="font-size:18px; margin-top:10px;" onclick="自動化執行()">自動化執行</button>
          
  </div>
  
  <br><br>
  <p id="machineStatus" class="NotoSansFont">機器狀態: </p>
 
  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-app.js"></script>
 
  <script>
    var useLocalAPIs = true;
  </script>
<!--
  <script src="3-controllers/functions.js"></script>
  <script src="1-models/data-process.js"></script>
  <script src="js/prettify.js"></script> 
-->
  
  <script>        
    var paramToSend = "";
    var inputParamString = location.search;
    var inputParam = inputParamString.split("&");
    var displayName, userId, pictureUrl;
    var inputError = false;
    
//    var 預設常用健身房 = "永和店";
//    
//    var 店面名稱=["永和店", "板橋店", "土城店", "錦州店",
//                 "三重店", "松山店", "府中店"                 
//                ]; // 測試用，之後從 API 取得
//
//    var 機器序號=["T00000001", "T00000002", "T00000003", "T00000004",
//                 "T00000005", "T00000006", "T00000007", "T00000008",
//                 "T00000009"                 
//                ]; // 測試用，之後從 API 取得      
    
    
    var powerIsOn =false;
    var res;
    if (useLocalAPIs) {
      var apiSite="http://localhost:5000/";
    } else {
      var apiSite="https://charder.herokuapp.com/";
    }
    
    var paramToSend;   
    
    async function getCMD(){
      if (!powerIsOn) {
        console.log("Power is not on, tuen on power first");
        //$("#machineStatus").text("請先打開機器電源");
        alert("請先打開機器電源");
        return;
      }
      
      //http://localhost:5000/cmd?XAPIKEY=LAotO6ljsV7rPLiT&Device_id=T00000001
      //paramToSend = "cmd?XAPIKEY=LAotO6ljsV7rPLiT&Device_id=T00000001";
      paramToSend = "cmd?XAPIKEY=LAotO6ljsV7rPLiT&Device_id="+$("#machineSN_select").val();
      res = await callGetAPI(paramToSend); 
      //console.log(typeof res);
      var result = JSON.parse(res);
      $("#get_timeStamp").text("Timestamp: "+String(result.Timestamp));
      $("#get_cmd").text("cmd: "+String(result.cmd));      
      $("#getCloudResponse").text(res);      
      
    }
 
    function callGetAPI(param) {      
      return new Promise(function(resolve, reject) {       
        var request = new XMLHttpRequest();
        request.open('GET', apiSite +param, true);

        request.onload = function() {
          //$.loading.end();
          //console.log(this.response);

          resolve(this.response);
        }
        // Send API request 
        //$.loading.start(loadingMessage);

        request.send();    
      });
    }
     
    var dataToPost = {
      "power_onT00000001": {
        "Timestamp":Date.now(),
        "status":"power_on",
        "Model": "MA801",
        "APPVer":"V59",
        "SN": "T00000001"
      },
      
      "power_onT00000002": {
        "Timestamp":Date.now(),
        "status":"power_on",
        "Model": "MA601",
        "APPVer":"V59",
        "SN": "T00000002"
      }, 
      
      "power_onT99999999": {
        "Timestamp":Date.now(),
        "status":"power_on",
        "Model": "UNKNOWN",
        "APPVer":"V59",
        "SN": "T99999999"
      },       
      
      "select_confirmed": {
        "Timestamp":Date.now(),
        "status":"select_confirmed"
      },
      
      "user_info_confirmed": {
        "Timestamp":Date.now(),
        "status":"user_info_confirmed"
      },      
      
      "logged_in": {
        "Timestamp":Date.now(),
        "status":"logged_in"
      },
      
      "start_weight_measurement": {
        "Timestamp":Date.now(),
        "status":"start_weight_measurement"
      }, 

      "weight_measurement_done": {
        "Timestamp":Date.now(),
        "status":"weight_measurement_done"
      },
      
      "check_electrodes": {
        "Timestamp":Date.now(),
        "status":"check_electrodes"
      }, 
            
      "check_electrodes_done": {
        "Timestamp":Date.now(),
        "status":"check_electrodes_done"
      }, 

      "start_bodycomposition_analysis": {
        "Timestamp":Date.now(),
        "status":"start_bodycomposition_analysis"
      },
      
      "bodycomposition_analysis_results": {
        "Timestamp":Date.now(),
        "status":"bodycomposition_analysis_results",
        "data": sample_data,
        "picture": sample_pic_data_base64, 
      }, 
      
      "cancel_confirmed": {
        "Timestamp":Date.now(),
        "status":"cancel_confirmed"
      },      
      
    }
     
    var postResponse;
    async function callPostData(dataToPost){
      //http://localhost:5000/status?XAPIKEY=LAotO6ljsV7rPLiT&Device_id=T00000001
      paramToSend = "status?XAPIKEY=LAotO6ljsV7rPLiT&Device_id="+$("#machineSN_select").val(); 
      res = await callPostAPI(paramToSend, dataToPost);      
    }
    
    function callPostAPI(param, dataToPost) {
      return new Promise(function(resolve, reject) {       
        var request = new XMLHttpRequest();   // new HttpRequest instance 
        //console.log(apiSite +param);
        request.open("POST", apiSite +param, true);
        request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        request.onload = function() { 
          console.log(this.response); 
          postResponse = "Response:"+this.response; 
          
        }  

        //console.log(JSON.stringify(dataToPost));
        request.send(JSON.stringify(dataToPost));  
      });
    }
    
    function powerToggle(){
      console.log("powerToggle", powerIsOn);
      
      if (powerIsOn) {
        $("#powerStatusIcon").css("background-color", "black");
        $("#machineType").text("");
        powerIsOn = false;
      } else {
        powerIsOn = true;
        postStatus("power_on"+$("#machineSN_select").val());
        
        $("#powerStatusIcon").css("background-color", "lawngreen");  
        console.log("power_on"+$("#machineSN_select").val());
        var postData = dataToPost["power_on"+$("#machineSN_select").val()];
        $("#machineType").text(postData.Model);
      }      
    }
    
    function changeMachine(){
      console.log("changeMachine");
      if (powerIsOn) powerToggle();
    }
    
    function postStatus(status){
      if (!powerIsOn) {
        console.log("Power is not on, tuen on power first");
        //$("#machineStatus").text("請先打開機器電源");
        alert("請先打開機器電源");
        return;
      }      
      console.log(status);
      $("#machineStatus").text(status);
      
      var postData = dataToPost[status];    
      console.log(postData);
      $("#post_timeStamp").text(postData.Timestamp);
      $("#post_status").text("status: "+String(postData.status));      
      
      callPostData(postData);
      $("#postCloudResponse").text(postResponse);      
            
      
    }
    
    function 自動化執行(){
      getCMD(); // get cmd: select
      
      setTimeout( function() {postStatus('select_confirmed')}, 1000);
      setTimeout( function() {getCMD()}, 2000); // get cmd: user_info      
      setTimeout( function() {postStatus('user_info_confirmed')}, 3000);
      setTimeout( function() {postStatus('logged_in')}, 4000); 
      setTimeout( function() {postStatus('start_weight_measurement')}, 4500);
      setTimeout( function() {postStatus('weight_measurement_done')}, 6000);
      setTimeout( function() {postStatus('check_electrodes')}, 7000);    
      setTimeout( function() {postStatus('check_electrodes_done')}, 8000);  
      setTimeout( function() {postStatus('bodycomposition_analysis_results')}, 9000); 
    }
        
  </script>
</body>

</html>
